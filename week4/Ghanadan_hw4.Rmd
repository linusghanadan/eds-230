---
title: "Assignment with Sobol"
author: "Linus Ghanadan"
---

# Part 1

## Paper: Sensitivity analysis of cooling demand applied to a large office building (Zeferina, Wood, Edwards, & Tian, 2021)

This scientific paper, which looks at a large office building and conducts a sensitivity analysis of a model built to estimate cooling demand, contributes substantially to understanding the environmental problem of how to meet design smart infrastructure grids that are built to be both reliable and energy efficient. Specifically, the study found that the ventilation rate parameter had the largest contribution to uncertainty in electricity demand with the end-use of heating, ventilation, and air-conditioning systems (HVAC). For overall electricity demand, ventilation rate still ranked high but not as high as equipment and lighting densities. In the context of managing energy use in buildings, this tells us that the most effective way to decrease electricity demanded from office buildings might be to decrease the lighting density and equipment, when possible. For example, more windows and open spaces would likely decrease the lighting density of a building because the windows and open spaces would bring in more natural light and decrease the significance of shadows. Furthermore, the fact that the ventilation rate parameter had the largest contribution to uncertainty compared to other HVAC systems, tells us that focusing on making more energy-efficient ventilation systems might be more of a priority than energy-efficiency innovation in heating or air-conditioning systems, at least as it applies to increasing energy efficiency in large office buildings.

# Part 2
## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# load libraries
library(sensitivity)
library(tidyverse)
library(purrr)
library(ggpubr)
#source("week3/Catm.R")
```

```{r}
set.seed(123)
```

```{r}
# define function from Catm.R (necessary to render)
Catm = function(v, height, k_o=0.1, k_d=0.7) {

    zm_add = 2
  
    zd = k_d*height
    zo = k_o*height

    zm = height+zm_add

    zd = ifelse(zd < 0, 0, zd)
    Ca = ifelse(zo > 0,
     v / (6.25*log((zm-zd)/zo)**2),0)

# convert to mm
    Ca = Ca*1000
   return(Ca)
}
```

 ## Generate parameter values
```{r}
# generate parameter samples
np <- 1000
k_o <- rnorm(np, mean=0.1, sd=0.1*0.1)
k_d <- rnorm(np, mean=0.7, sd=0.7*0.1)
v <- rnorm(np, mean=300, sd=50)
height <- runif(np, min=3.5, max=5.5)

X1 <- cbind.data.frame(k_o, k_d, v, height=height)

# generate another set of parameter samples
k_o <- rnorm(np, mean=0.1, sd=0.1*0.1)
k_d <- rnorm(np, mean=0.7, sd=0.7*0.1)
v <- rnorm(np, mean=300, sd=50)
height <- runif(np, min=3.5, max=5.5)

X2 <- cbind.data.frame(k_o, k_d, v, height=height)
```

## Run atmospheric conductance model for these parameters
```{r}
# use Jansen approach implemented by sobolSalt
sens_Catm_Sobol <- sobolSalt(model = NULL, X1, X2, nboot = 100)

# define parameters
parms <- as.data.frame(sens_Catm_Sobol$X)
colnames(parms) <- colnames(X1)

# run the model
res = pmap_dbl(parms, Catm)

# update the sensitivity analysis object with the results
sens_Catm_Sobol <- sensitivity::tell(sens_Catm_Sobol, res, res.names = "ga")
```

## Plot conductance estimates with parameter uncertainty

```{r}
# plot distribution of conductance estimates
ggplot(data = data.frame(Ca = res), aes(x = Ca)) +
  geom_density(fill="cornflowerblue", alpha=0.5) +
  labs(title = "Density Plot of Conductance Estimates", x = "Conductance (mm/s)", y = "Density")
```

## Plot conductance estimates against windspeed

```{r}
# calculate total sensitivity indices
total_sensitivity <- apply(sens_Catm_Sobol$T, 1, mean)

# plot total sensitivity indices to identify second most influential parameter
barplot(total_sensitivity, names.arg = colnames(X1),
        main = "Total Sensitivity Indices",
        ylab = "Total Effect", xlab = "Parameters",
        col = "darkseagreen")
```

```{r}
# plot two most sensitive parameters
both = cbind.data.frame(parms, gs=sens_Catm_Sobol$y)
ggplot(both, aes(v,gs, col=k_o))+geom_point()+labs(y="Conductance (mm/s)", x="Windspeed (cm/s")
```

## Estimate Sobol indices

```{r}
# add parameter names to main effect and total sensitivity indices
row.names(sens_Catm_Sobol$S) = colnames(parms)
row.names(sens_Catm_Sobol$T) = colnames(parms)

# print all sobol indices
print(sens_Catm_Sobol)
```

## What this tells us about atmospheric conductance

In this setting (compared to the setting looked at in class), windspeed was higher and less variable, while vegetation was shorter. Comparing the two sensitivity analyses, we can see that these differences in conditions was associated with a decrease in model variance, as the model variance determined here (~8.4 million) was less than half the variance we found in class (~19.7 million). In addition, for the model we look at here, the total sensitivity index for k_d is significantly lower, while that for k_o, windspeed, and height are significantly higher. Because the total sensitivity index for windspeed is significantly higher, this tells us that atmospheric conductance is more sensitive to windspeed in areas where windspeed is high and less variable and vegetation is shorter. However, the lower model variance tells us that overall, atmospheric conductance has less variation in these conditions.


